<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meu Gestor Financeiro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans" style="font-family: 'Inter', sans-serif;">

    <!-- Overlay de Carregamento Inicial -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-600 mt-4">Carregando seu Gestor Financeiro...</p>
    </div>

    <!-- Container Principal do App -->
    <div id="main-app" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg opacity-0 transition-opacity duration-500 pb-24">
        
        <!-- ========================== -->
        <!-- PÁGINA 1: DASHBOARD        -->
        <!-- ========================== -->
        <div id="page-dashboard" class="p-4 space-y-4">
            <header class="mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Meu Gestor Financeiro</h1>
                <p class="text-gray-500">Sua visão geral proativa.</p>
            </header>

            <!-- Widget 1: Situação da Conta (O FOCO) -->
            <div class="bg-blue-600 text-white p-4 rounded-xl shadow-lg">
                <span class="text-sm text-blue-200 block">Orçamento Disponível Real</span>
                <span id="real-budget" class="text-4xl font-bold block">R$ 0,00</span>
                <div class="mt-3 pt-3 border-t border-blue-500 text-sm space-y-1">
                    <div class="flex justify-between">
                        <span class="text-blue-200">Saldo na Conta</span>
                        <span id="account-balance" class="font-medium">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-blue-200">Contas Pendentes</span>
                        <span id="pending-bills" class="font-medium">(-) R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- Botão de IA -->
            <button id="analyze-expenses-btn" class="w-full bg-indigo-500 text-white py-3 px-4 rounded-lg shadow hover:bg-indigo-600 transition-all flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5.5 8a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v2a.5.5 0 01-.5.5h-2a.5.5 0 01-.5-.5V8zm7 0a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v2a.5.5 0 01-.5.5h-2a.5.5 0 01-.5-.5V8zM5 12a1 1 0 100 2h10a1 1 0 100-2H5z" clip-rule="evenodd" />
                </svg>
                <span>Analisar Gastos (IA)</span>
            </button>

            <!-- Widget 2: Onde Está o Meu Dinheiro -->
            <div class="bg-white p-4 rounded-xl shadow border border-gray-200">
                <h2 class="font-bold text-gray-700 mb-3">Onde Está o Meu Dinheiro</h2>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Disponível na Conta</span>
                        <span id="available-on-account" class="font-semibold text-lg text-gray-800">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Na Carteira (Físico)</span>
                        <span id="wallet-balance" class="font-semibold text-lg text-gray-800">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">No "Cofre" (120% CDI)</span>
                        <span id="cofre-balance" class="font-semibold text-lg text-gray-800">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- Widget 3: Situação do Cartão (Meta 1) -->
            <div class="bg-white p-4 rounded-xl shadow border border-gray-200">
                <h2 class="font-bold text-red-600 mb-3">Meta 1: Cartão de Crédito</h2>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Fatura Estimada (Dez)</span>
                        <span id="credit-card-bill" class="font-semibold text-lg text-red-600">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Limite Disponível</span>
                        <span id="credit-card-limit" class="font-semibold text-lg text-green-600">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Valor "Preso" (Reserva)</span>
                        <span id="credit-card-reserved" class="font-semibold text-lg text-gray-800">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- Widget 4: Pendências -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-green-100 p-3 rounded-xl text-center">
                    <span class="text-sm text-green-700 block">A Receber</span>
                    <span id="to-receive-summary" class="text-xl font-bold text-green-800">R$ 0,00</span>
                </div>
                <div class="bg-red-100 p-3 rounded-xl text-center">
                    <span class="text-sm text-red-700 block">A Pagar</span>
                    <span id="to-pay-summary" class="text-xl font-bold text-red-800">R$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- ========================== -->
        <!-- PÁGINA 2: LANÇAR TRANSAÇÃO -->
        <!-- ========================== -->
        <div id="page-launch" class="p-4" style="display: none;">
            <header class="mb-4">
                <h1 id="form-title" class="text-2xl font-bold text-gray-800">Lançar Transação</h1>
            </header>
            
            <form id="launch-form" class="space-y-4">
                <div>
                    <label for="transaction-value" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" step="0.01" id="transaction-value" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="transaction-date" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="transaction-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="transaction-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="Gasto">Gasto</option>
                            <option value="Recebimento">Recebimento</option>
                            <option value="Transferência">Transferência</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="transaction-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="transaction-description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div id="payment-origin-container">
                        <label for="payment-origin" class="block text-sm font-medium text-gray-700">Origem</label>
                        <select id="payment-origin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="conta_principal">Conta Principal</option>
                            <option value="carteira">Carteira</option>
                            <option value="cofre">Cofre</option>
                            <option value="cartao_credito">Cartão de Crédito</option>
                        </select>
                    </div>
                    
                    <div id="destination-container" class="hidden">
                        <label for="destination-account" class="block text-sm font-medium text-gray-700">Destino</label>
                        <select id="destination-account" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="conta_principal">Conta Principal</option>
                            <option value="carteira">Carteira</option>
                            <option value="cofre">Cofre</option>
                        </select>
                    </div>
                </div>

                <div id="category-container" class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="transaction-category" class="block text-sm font-medium text-gray-700">Categoria</label>
                        <select id="transaction-category" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div id="subcategory-container">
                        <label for="transaction-subcategory" class="block text-sm font-medium text-gray-700">Subcategoria</label>
                        <select id="transaction-subcategory" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>
                
                <div id="tags-container">
                    <label for="transaction-tags" class="block text-sm font-medium text-gray-700">Etiquetas (Ex: Namorada, Família)</label>
                    <input type="text" id="transaction-tags" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div id="is-reimbursement-container" class="flex items-center">
                    <input id="is-reimbursement" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="is-reimbursement" class="ml-2 block text-sm text-gray-900">É um Reembolso? (Move para "A Receber")</label>
                </div>
                
                <div>
                    <button id="submit-transaction" type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg shadow font-semibold hover:bg-blue-700 transition-all">
                        Salvar Lançamento
                    </button>
                </div>
            </form>
        </div>
        
        <!-- ========================== -->
        <!-- PÁGINA 3: DETALHES DO COFRE -->
        <!-- ========================== -->
        <div id="page-cofre" class="p-4" style="display: none;">
            <header class="mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Detalhes do "Cofre"</h1>
                <p class="text-gray-500">Seu dinheiro rendendo a 120% CDI.</p>
            </header>
            
            <div class="bg-gray-100 p-4 rounded-xl text-center mb-4">
                <span class="text-sm text-gray-600 block">Total no Cofre</span>
                <span id="cofre-total" class="text-4xl font-bold text-gray-900">R$ 0,00</span>
            </div>
            
            <div class="space-y-3">
                <h2 class="font-bold text-lg text-gray-700">Detalhamento:</h2>
                <div class="bg-yellow-100 p-4 rounded-lg border border-yellow-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-yellow-800">Dinheiro RESERVADO (Contas)</span>
                        <span id="cofre-reserved-bills" class="font-bold text-yellow-900 text-lg">R$ 0,00</span>
                    </div>
                    <p class="text-sm text-yellow-700 mt-1">Para contas futuras (Dezembro).</p>
                </div>
                <div class="bg-cyan-100 p-4 rounded-lg border border-cyan-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-cyan-800">Dinheiro RESERVADO (Envelope VT)</span>
                        <span id="cofre-reserved-vt" class="font-bold text-cyan-900 text-lg">R$ 0,00</span>
                    </div>
                    <p class="text-sm text-cyan-700 mt-1">Saldo total do seu benefício.</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg border border-green-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-green-800">Dinheiro LIVRE (Poupança)</span>
                        <span id="cofre-free-money" class="font-bold text-green-900 text-lg">R$ 0,00</span>
                    </div>
                    <p class="text-sm text-green-700 mt-1">Seu dinheiro extra para metas e lazer.</p>
                </div>
            </div>
        </div>

        <!-- ========================== -->
        <!-- PÁGINA 4: ENVELOPE VT      -->
        <!-- ========================== -->
        <div id="page-vt" class="p-4" style="display: none;">
            <header class="mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Envelope VT</h1>
                <p class="text-gray-500">Controle do seu benefício de transporte.</p>
            </header>
            
            <div class="bg-gray-100 p-4 rounded-xl text-center mb-4">
                <span class="text-sm text-gray-600 block">Saldo Restante no Benefício</span>
                <span id="vt-remaining" class="text-4xl font-bold text-gray-900">R$ 0,00</span>
            </div>
            
            <div class="space-y-3">
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Orçamento VT (Novembro)</span>
                        <span id="vt-budget-nov" class="font-semibold text-lg text-gray-800">R$ 0,00</span>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Orçamento VT (Dezembro)</span>
                        <span id="vt-budget-dec" class="font-semibold text-lg text-gray-800">R$ 0,00</span>
                    </div>
                </div>
                <div class="bg-red-100 p-4 rounded-lg border border-red-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-red-800">Total Gasto (Recargas)</span>
                        <span id="vt-spent" class="font-bold text-red-900 text-lg">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================== -->
        <!-- PÁGINA 5: RELATÓRIOS       -->
        <!-- ========================== -->
        <div id="page-reports" class="p-4" style="display: none;">
            <header class="mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Relatórios</h1>
                <p class="text-gray-500">Entenda seus padrões de gastos.</p>
            </header>
            
            <div class="flex space-x-2 mb-4">
                <button id="simple-report-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-blue-600 text-white transition-all">
                    Relatório Rápido (Variáveis)
                </button>
                <button id="full-report-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-gray-200 text-gray-700 transition-all">
                    Relatório Completo (Total)
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                <h2 id="report-title" class="p-3 font-bold text-gray-700 border-b border-gray-200">Carregando relatório...</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead id="report-table-head" class="bg-gray-50">
                            <!-- Cabeçalho dinâmico -->
                        </thead>
                        <tbody id="report-table-body">
                            <!-- Corpo dinâmico -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div> <!-- Fim de #main-app -->

    <!-- ========================== -->
    <!-- BARRA DE NAVEGAÇÃO INFERIOR -->
    <!-- ========================== -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white border-t border-gray-200 shadow-md h-20 flex justify-around items-center">
        <button data-page="dashboard" class="nav-button flex flex-col items-center justify-center text-blue-600 bg-blue-100 rounded-lg p-2 w-16 h-16">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1zm5 0a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" />
            </svg>
            <span class="text-xs font-medium">Início</span>
        </button>
        <button data-page="cofre" class="nav-button flex flex-col items-center justify-center text-gray-600 p-2 w-16 h-16">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4-8-4V7l8-4 8 4z" />
            </svg>
            <span class="text-xs font-medium">Cofre</span>
        </button>
        <button data-page="launch" class="nav-button flex flex-col items-center justify-center text-gray-600 p-2 w-20 h-20 bg-blue-600 text-white rounded-full shadow-lg -mt-10 border-4 border-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span class="text-xs font-medium -mt-1">Lançar</span>
        </button>
        <button data-page="vt" class="nav-button flex flex-col items-center justify-center text-gray-600 p-2 w-16 h-16">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            <span class="text-xs font-medium">VT</span>
        </button>
        <button data-page="reports" class="nav-button flex flex-col items-center justify-center text-gray-600 p-2 w-16 h-16">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2z" />
            </svg>
            <span class="text-xs font-medium">Relatos</span>
        </button>
    </nav>

    <!-- ========================== -->
    <!-- MODAIS (Pop-ups)           -->
    <!-- ========================== -->

    <!-- Modal 1: Pergunta do VT (Lógica de Negócio 1) -->
    <div id="vt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Lançamento de Salário</h2>
            <p class="text-gray-600 mb-4">Quanto deste valor total (R$) é referente ao Vale Transporte (VT)?</p>
            <label for="vt-amount" class="block text-sm font-medium text-gray-700">Valor do VT</label>
            <input type="number" step="0.01" id="vt-amount" placeholder="0,00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg">
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-vt-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="save-vt-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal 2: Alerta IA (Filosofia do Site) -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex items-center space-x-3 mb-4">
                <span class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M12 21v-1" />
                    </svg>
                </span>
                <h2 class="text-lg font-bold text-gray-800">Gestor Financeiro</h2>
            </div>
            <p id="ai-modal-message" class="text-gray-600 mb-6">Notei este gasto. Como ele se encaixa no seu plano de quitar o cartão este mês?</p>
            <div class="flex justify-end space-x-3">
                <button id="ai-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ignorar</button>
                <button id="ai-modal-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entendido</button>
            </div>
        </div>
    </div>
    
    <!-- Modal 3: Alerta Simples (Erros/Sucesso) -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h2 id="alert-title" class="text-lg font-bold text-gray-800 mb-4">Aviso</h2>
            <div id="alert-message" class="text-gray-600 mb-6 prose prose-sm max-w-none">
                Mensagem de alerta aqui.
            </div>
            <div class="flex justify-end">
                <button id="alert-close-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal 4: Carregando (Ações) -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-50 p-4 hidden">
        <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-modal-message" class="text-white mt-4">Salvando transação...</p>
    </div>

    <!-- Estilos Personalizados (Necessários) -->
    <style>
        body {
            /* Impede o "pulo" da barra de rolagem */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Oculta a barra de rolagem principal, mas permite rolar */
        /* ::-webkit-scrollbar {
            display: none;
        } */
        /* Força a altura da viewport no mobile, corrigindo bug da barra de navegação */
        @supports (-webkit-touch-callout: none) {
            .min-h-screen {
                min-height: -webkit-fill-available;
            }
        }
    </style>
    
</body>
<!-- Firebase JS SDKs e Lógica do App -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, 
            query, where, getDocs, writeBatch, serverTimestamp, 
            onSnapshot, orderBy, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        
        let db, auth, userId;
        // O appId agora é fixo para o seu projeto pessoal,
        // já que não estamos mais no ambiente Canvas.
        const appId = "meu-gestor-pessoal"; 
        
        let unsubscribeSnapshots = []; // Para limpar ouvintes

        // --- SEU CÓDIGO firebaseConfig JÁ ESTÁ NO LUGAR CERTO ---
        const firebaseConfig = {
          apiKey: "AIzaSyDwsP7grq5wBouOYhv6RyzhsPe7EZyK6Ik",
          authDomain: "meu-gestor-finaceiro.firebaseapp.com",
          projectId: "meu-gestor-finaceiro",
          storageBucket: "meu-gestor-finaceiro.firebasestorage.app",
          messagingSenderId: "463881362430",
          appId: "1:463881362430:web:131c38771befd35f7e3eaf"
        };
        // --- FIM DA ÁREA DE COLAR ---


        const loadingOverlay = document.getElementById('loading-overlay');
        const mainApp = document.getElementById('main-app');

        const dashboardPage = document.getElementById('page-dashboard');
        const launchPage = document.getElementById('page-launch');
        const cofrePage = document.getElementById('page-cofre');
        const vtPage = document.getElementById('page-vt');
        const reportsPage = document.getElementById('page-reports');
        const navButtons = document.querySelectorAll('.nav-button');

        const pages = {
            'dashboard': dashboardPage,
            'launch': launchPage,
            'cofre': cofrePage,
            'vt': vtPage,
            'reports': reportsPage
        };

        // Elementos do Dashboard
        const realBudgetEl = document.getElementById('real-budget');
        const accountBalanceEl = document.getElementById('account-balance');
        const pendingBillsEl = document.getElementById('pending-bills');
        const availableOnAccountEl = document.getElementById('available-on-account');
        const walletBalanceEl = document.getElementById('wallet-balance');
        const cofreBalanceEl = document.getElementById('cofre-balance');
        const creditCardBillEl = document.getElementById('credit-card-bill');
        const creditCardLimitEl = document.getElementById('credit-card-limit');
        const creditCardReservedEl = document.getElementById('credit-card-reserved');
        const toReceiveEl = document.getElementById('to-receive-summary');
        const toPayEl = document.getElementById('to-pay-summary');

        // Elementos do Formulário de Lançamento
        const launchForm = document.getElementById('launch-form');
        const formTitle = document.getElementById('form-title');
        const transactionValue = document.getElementById('transaction-value');
        const transactionDate = document.getElementById('transaction-date');
        const transactionDescription = document.getElementById('transaction-description');
        const transactionType = document.getElementById('transaction-type');
        const paymentOriginContainer = document.getElementById('payment-origin-container');
        const paymentOrigin = document.getElementById('payment-origin');
        const destinationContainer = document.getElementById('destination-container');
        const destinationAccount = document.getElementById('destination-account');
        const categoryContainer = document.getElementById('category-container');
        const transactionCategory = document.getElementById('transaction-category');
        const subcategoryContainer = document.getElementById('subcategory-container');
        const transactionSubcategory = document.getElementById('transaction-subcategory');
        const tagsContainer = document.getElementById('tags-container');
        const transactionTags = document.getElementById('transaction-tags');
        const isReimbursementContainer = document.getElementById('is-reimbursement-container');
        const isReimbursement = document.getElementById('is-reimbursement');
        const submitButton = document.getElementById('submit-transaction');

        // Elementos do Modal (VT, IA, Alerta, Carregando)
        const vtModal = document.getElementById('vt-modal');
        const vtAmountInput = document.getElementById('vt-amount');
        const saveVtBtn = document.getElementById('save-vt-btn');
        const cancelVtBtn = document.getElementById('cancel-vt-btn');

        const aiModal = document.getElementById('ai-modal');
        const aiModalMessage = document.getElementById('ai-modal-message');
        const aiModalConfirm = document.getElementById('ai-modal-confirm');
        const aiModalCancel = document.getElementById('ai-modal-cancel');

        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseBtn = document.getElementById('alert-close-btn');

        const loadingModal = document.getElementById('loading-modal');
        const loadingModalMessage = document.getElementById('loading-modal-message');

        // Elementos do Cofre
        const cofreTotalEl = document.getElementById('cofre-total');
        const cofreReservedBillsEl = document.getElementById('cofre-reserved-bills');
        const cofreReservedVtEl = document.getElementById('cofre-reserved-vt');
        const cofreFreeMoneyEl = document.getElementById('cofre-free-money');

        // Elementos do VT
        const vtBudgetNovEl = document.getElementById('vt-budget-nov');
        const vtBudgetDecEl = document.getElementById('vt-budget-dec');
        const vtSpentEl = document.getElementById('vt-spent');
        const vtRemainingEl = document.getElementById('vt-remaining');

        // Elementos dos Relatórios
        const simpleReportBtn = document.getElementById('simple-report-btn');
        const fullReportBtn = document.getElementById('full-report-btn');
        const reportOutput = document.getElementById('report-output');
        const reportTitle = document.getElementById('report-title');
        const reportTableHead = document.getElementById('report-table-head');
        const reportTableBody = document.getElementById('report-table-body');
        
        // Botões de IA
        const analyzeExpensesBtn = document.getElementById('analyze-expenses-btn');
        
        // Definições de Categorias (baseado no seu uso)
        const categories = {
            "Recebimento": ["Salário", "13º Salário", "Reembolso", "Empréstimo", "Outro"],
            "Gasto": [
                "Moradia", "Transporte", "Alimentação", "Saúde", "Educação", 
                "Contas Fixas", "Dívidas", "Compras", "Lazer", "Bem-estar", "Empréstimo", "Outros"
            ],
            "Transferência": ["Entre Contas"]
        };

        const subcategories = {
            "Transporte": ["App", "Pedágio", "Recarga VT", "Outro"],
            "Alimentação": ["Lanche", "Delivery", "Mercado", "Restaurante", "Outro"],
            "Contas Fixas": ["Carro", "Faculdade", "TV", "Internet", "Celular", "Gympass", "Barbeiro", "Água"],
            "Dívidas": ["Alex Computador"],
            "Educação": ["Papelaria", "Impressão"],
            "Lazer": ["Barzinho", "Cinema", "Outro"],
            "Bem-estar": ["Trança", "Outro"],
            "Saúde": ["Remédios", "Outro"],
            "Compras": ["Perfume", "Roupas", "Outros", "Lentes"],
            "Empréstimo": ["Pai", "Mãe"]
        };
        
        // Estado global da aplicação
        let globalState = {
            accounts: {},
            transactions: [],
            pending: {},
            vtEnvelope: {},
            creditCard: {},
            isDataSeeded: false
        };

        // --- DADOS INICIAIS (SEED) ---
        // Povoa o banco de dados na primeira inicialização
        // Baseado EXATAMENTE no seu "RELATÓRIO FINANCEIRO COMPLETO"
        
        const initialSeedData = {
            isDataSeeded: true,
            accounts: {
                "conta_principal": 386.53,
                "carteira": 0.00,
                "cofre": 3283.31,
                "cartao_transporte": 224.80 
            },
            creditCard: {
                currentBill: 1127.78,
                availableLimit: 86.39,
                reservedLimit: 300.00,
                totalLimitBase: 3200.00, // (3500 - 300)
                nextFixedEntries: [
                    { name: "Gympass", value: 179.70 },
                    { name: "Lentes (1/10)", value: 126.00 }
                ]
            },
            pending: {
                toReceive: [
                    { id: "rec1", from: "Pai", reason: "Empréstimo (100)", value: 100.00, received: false },
                    { id: "rec2", from: "Pai", reason: "Empréstimo (200)", value: 200.00, received: false },
                    { id: "rec3", from: "Pai", reason: "Reembolso Rodízio", value: 180.00, received: false },
                    { id: "rec4", from: "Pai", reason: "Reembolso Gympass", value: 59.90, received: false }
                ],
                toPay: [
                    { id: "pay1", to: "Mãe", reason: "Troco Reembolso Rodízio", value: 20.00, paid: false }
                ]
            },
            vtEnvelope: {
                budgets: { "Novembro": 500.00, "Dezembro": 500.00 },
                totalSpent: 224.80, // O valor que já está no cartão de transporte
                totalBalance: 775.20 // Saldo restante (Nov+Dec) - Gasto
            },
            cofreDetails: {
                reservedForBills: 1008.11,
                reservedForVT: 775.20,
                freeMoney: 1500.00
            },
            // Contas fixas pendentes para o cálculo do "Orçamento Real"
            pendingBills: [
                 { id: "bill1", name: "Plano de Celular (Novembro)", value: 285.00, paid: false }
            ],
            // Transações baseadas no seu "REGISTO HISTÓRICO"
            transactions: [
                { date: "2025-10-31", type: "Gasto", category: "Contas Fixas", subcategory: "Carro", description: "Pagto Carro (Nov + Dez)", value: 1000.00, origin: "cofre" },
                { date: "2025-10-31", type: "Gasto", category: "Contas Fixas", subcategory: "Faculdade", description: "Pagto Faculdade (Nov + Dez) + Multa", value: 1076.58, origin: "cofre" },
                { date: "2025-10-31", type: "Gasto", category: "Contas Fixas", subcategory: "TV", description: "TV a Cabo (Nov)", value: 80.00, origin: "cofre" },
                { date: "2025-10-31", type: "Gasto", category: "Contas Fixas", subcategory: "Internet", description: "Internet (Nov)", value: 99.99, origin: "cofre" },
                { date: "2025-10-31", type: "Gasto", category: "Dívidas", subcategory: "Alex Computador", description: "Dívida (Alex - Nov + Dez)", value: 200.00, origin: "cofre" },
                { date: "2025-10-31", type: "Gasto", category: "Contas Fixas", subcategory: "Barbeiro", description: "Barbeiro (Nov)", value: 180.00, origin: "cofre" },
                { date: "2025-10-31", type: "Gasto", category: "Alimentação", subcategory: "Delivery", description: "Pizza", value: 50.00, origin: "conta_principal" },
                
                { date: "2025-11-01", type: "Gasto", category: "Saúde", subcategory: "Remédios", description: "Remédios", value: 379.29, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Educação", subcategory: "Papelaria", description: "Papelaria", value: 6.00, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Pastel", value: 13.00, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Doce", value: 4.99, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Picolé", value: 2.50, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Picolé", value: 1.75, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Bolo de Pote - Namorada", value: 24.00, origin: "conta_principal", tags: "Namorada" },
                { date: "2025-11-01", type: "Gasto", category: "Transporte", subcategory: "Pedágio", description: "Pedágio", value: 3.50, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Moradia", subcategory: "Água", description: "Pagto Água (Nov)", value: 183.42, origin: "conta_principal" },
                { date: "2025-11-01", type: "Gasto", category: "Empréstimo", subcategory: "Pai", description: "Empréstimo (Pai - a receber)", value: 100.00, origin: "conta_principal", isReimbursement: true },
                { date: "2025-11-01", type: "Gasto", category: "Alimentação", subcategory: "Restaurante", description: "Hambúrguer - Namorada", value: 90.97, origin: "conta_principal", tags: "Namorada" },

                { date: "2025-11-02", type: "Gasto", category: "Alimentação", subcategory: "Restaurante", description: "Seu gasto Rodízio - Namorada", value: 240.00, origin: "conta_principal", tags: "Namorada" },
                { date: "2025-11-02", type: "Gasto", category: "Empréstimo", subcategory: "Pai", description: "Empréstimo (Pai - a receber)", value: 180.00, origin: "conta_principal", isReimbursement: true },
                { date: "2025-11-02", type: "Gasto", category: "Empréstimo", subcategory: "Mãe", description: "Empréstimo (Mãe - a receber)", value: 180.00, origin: "conta_principal", isReimbursement: true }, // Este foi o que gerou o troco de R$20

                { date: "2025-11-03", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Doce - Carteira", value: 6.00, origin: "carteira" },
                
                { date: "2025-11-04", type: "Gasto", category: "Outros", subcategory: "Outro", description: "Edição de Foto", value: 9.00, origin: "conta_principal" },
                { date: "2025-11-04", type: "Gasto", category: "Transporte", subcategory: "App", description: "Uber", value: 11.98, origin: "cartao_credito" },
                { date: "2025-11-04", type: "Gasto", category: "Lazer", subcategory: "Cinema", description: "Cinemark", value: 40.90, origin: "cartao_credito" },
                
                { date: "2025-11-05", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "McDonald's", value: 38.90, origin: "conta_principal" },
                
                { date: "2025-11-06", type: "Gasto", category: "Contas Fixas", subcategory: "Pagamento Fatura", description: "Fatura Cartão (Novembro)", value: 447.71, origin: "conta_principal" },
                { date: "2025-11-06", type: "Gasto", category: "Educação", subcategory: "Impressão", description: "Impressão - Ajuste", value: 2.60, origin: "conta_principal" },
                { date: "2025-11-06", type: "Gasto", category: "Compras", subcategory: "Perfume", description: "Perfume", value: 98.00, origin: "conta_principal" },
                { date: "2025-11-06", type: "Gasto", category: "Educação", subcategory: "Papelaria", description: "Papelaria", value: 16.00, origin: "conta_principal" },
                
                { date: "2025-11-07", type: "Gasto", category: "Bem-estar", subcategory: "Trança", description: "Trança", value: 100.00, origin: "conta_principal" },
                { date: "2025-11-07", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Picolé", value: 2.50, origin: "conta_principal" },
                { date: "2025-11-07", type: "Gasto", category: "Lazer", subcategory: "Barzinho", description: "Barzinho - Namorada", value: 263.00, origin: "conta_principal", tags: "Namorada" },
                { date: "2025-11-07", type: "Gasto", category: "Transporte", subcategory: "App", description: "Uber", value: 15.95, origin: "cartao_credito" },
                
                { date: "2025-11-08", type: "Gasto", category: "Transporte", subcategory: "App", description: "Uber - Namorada", value: 80.00, origin: "conta_principal", tags: "Namorada" },
                { date: "2025-11-08", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Bolacha", value: 5.99, origin: "conta_principal" },
                { date: "2025-11-08", type: "Gasto", category: "Transporte", subcategory: "Pedágio", description: "Pedágio", value: 3.50, origin: "conta_principal" },
                
                { date: "2025-11-09", type: "Gasto", category: "Empréstimo", subcategory: "Pai", description: "Empréstimo (Pai - a receber)", value: 200.00, origin: "conta_principal", isReimbursement: true },
                { date: "2025-11-09", type: "Gasto", category: "Transporte", subcategory: "Pedágio", description: "Pedágio", value: 3.50, origin: "conta_principal" },
                { date: "2025-11-09", type: "Gasto", category: "Compras", subcategory: "Outros", description: "Água Micelar", value: 35.99, origin: "conta_principal" },
                { date: "2025-11-09", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Cachorro Quente", value: 8.00, origin: "conta_principal" },
                { date: "2025-11-09", type: "Gasto", category: "Transporte", subcategory: "App", description: "Uber", value: 13.90, origin: "cartao_credito" },

                { date: "2025-11-10", type: "Gasto", category: "Educação", subcategory: "Impressão", description: "Impressão", value: 3.00, origin: "conta_principal" },
                { date: "2025-11-10", type: "Gasto", category: "Alimentação", subcategory: "Lanche", description: "Salgado", value: 10.00, origin: "conta_principal" },
                { date: "2025-11-10", type: "Gasto", category: "Compras", subcategory: "Lentes", description: "Lentes (Parcela 1/10)", value: 126.00, origin: "cartao_credito" }
            ]
        };

        // --- INICIALIZAÇÃO DO FIREBASE E AUTENTICAÇÃO ---
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Esta é a mudança principal. Se não houver config, o app para.
                if (!firebaseConfig.apiKey) {
                    showError("Configuração do Firebase não encontrada. Por favor, siga o 'guia_firebase.md' e cole seu `firebaseConfig` no Bloco 3 do HTML.");
                    loadingOverlay.style.display = 'none';
                    mainApp.classList.add('opacity-0'); // Mantém o app oculto
                    return;
                }

                // Inicializar Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); // 'debug' para ver logs

                // Autenticar Anonimamente. 
                // O __initial_auth_token não existe fora do Canvas.
                await signInAnonymously(auth);

                // Ouvir mudanças de auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Agora que temos userId, podemos carregar os dados
                        loadDataAndSetupListeners();
                    } else {
                        userId = null;
                        loadingOverlay.style.display = 'none';
                        mainApp.classList.add('opacity-0');
                        showError("Falha na autenticação. Por favor, recarregue.");
                    }
                });

                setupGlobalEventListeners();

            } catch (error) {
                console.error("Erro fatal na inicialização:", error);
                showError(`Erro fatal na inicialização: ${error.message}`);
                loadingOverlay.style.display = 'none';
            }
        });
        
        // --- LÓGICA DE DADOS (FIREBASE) ---

        async function loadDataAndSetupListeners() {
            if (!db || !userId) return;

            loadingOverlay.style.display = 'flex';
            
            // Limpar ouvintes antigos
            unsubscribeSnapshots.forEach(unsub => unsub());
            unsubscribeSnapshots = [];

            try {
                // Caminho para o documento principal do usuário
                // Note que mudei o caminho para ser mais simples e bater com as Regras
                const userDocRef = doc(db, `gestorFinanceiro/${userId}`);
                
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    // Primeira vez do usuário, vamos popular com os dados iniciais
                    await seedInitialData(userDocRef);
                    globalState = { ...initialSeedData }; // Carrega no estado global
                } else {
                    // Usuário existente, carregar dados
                    const data = userDoc.data();
                    globalState.isDataSeeded = data.isDataSeeded || true; // Garante que não façamos seed novamente
                    globalState.accounts = data.accounts || initialSeedData.accounts;
                    globalState.creditCard = data.creditCard || initialSeedData.creditCard;
                    globalState.pending = data.pending || initialSeedData.pending;
                    globalState.vtEnvelope = data.vtEnvelope || initialSeedData.vtEnvelope;
                    globalState.cofreDetails = data.cofreDetails || initialSeedData.cofreDetails;
                    globalState.pendingBills = data.pendingBills || initialSeedData.pendingBills;
                }

                // Configurar ouvintes (onSnapshot) para dados em tempo real
                
                // 1. Ouvinte para o documento principal (contas, metas, etc.)
                const unsubDoc = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        globalState.accounts = data.accounts;
                        globalState.creditCard = data.creditCard;
                        globalState.pending = data.pending;
                        globalState.vtEnvelope = data.vtEnvelope;
                        globalState.cofreDetails = data.cofreDetails;
                        globalState.pendingBills = data.pendingBills;
                        updateAllUI(globalState); // Atualiza UI com novos dados
                    }
                }, (error) => {
                    console.error("Erro no listener do documento:", error);
                    showError("Erro ao sincronizar dados. Tentando reconectar...");
                });
                unsubscribeSnapshots.push(unsubDoc);

                // 2. Ouvinte para a subcoleção de transações
                const transColRef = collection(userDocRef, "transactions");
                const q = query(transColRef, orderBy("date", "desc"));

                const unsubTrans = onSnapshot(q, (snapshot) => {
                    globalState.transactions = [];
                    snapshot.forEach((doc) => {
                        globalState.transactions.push({ id: doc.id, ...doc.data() });
                    });
                    // Após carregar transações, atualiza UI (especialmente relatórios)
                    updateAllUI(globalState);
                }, (error) => {
                    console.error("Erro no listener de transações:", error);
                    showError("Erro ao sincronizar transações. Tentando reconectar...");
                });
                unsubscribeSnapshots.push(unsubTrans);

                // Carregamento inicial concluído
                loadingOverlay.style.display = 'none';
                mainApp.classList.remove('opacity-0');
                
                // Mostrar a página inicial
                navigateTo('dashboard');

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showError(`Erro ao carregar dados: ${error.message}`);
                loadingOverlay.style.display = 'none';
            }
        }

        // Função para popular o banco de dados com os dados iniciais
        async function seedInitialData(userDocRef) {
            if (!db || !userId) return;

            try {
                const batch = writeBatch(db);

                // 1. Define o documento principal
                const mainData = { ...initialSeedData };
                delete mainData.transactions; // Transações vão para subcoleção
                mainData.createdAt = serverTimestamp();
                
                batch.set(userDocRef, mainData);

                // 2. Adiciona todas as transações à subcoleção
                const transColRef = collection(userDocRef, "transactions");
                
                initialSeedData.transactions.forEach((tx, index) => {
                    // Usar um ID mais robusto para evitar colisões
                    const docId = `${tx.date}_${index}_${Math.random().toString(36).substring(2, 9)}`;
                    const newDocRef = doc(transColRef, docId);
                    batch.set(newDocRef, tx);
                });

                await batch.commit();

            } catch (error) {
                console.error("Erro ao popular dados iniciais:", error);
                showError(`Erro ao configurar sua conta: ${error.message}`);
            }
        }
        
        // --- LÓGICA DE ATUALIZAÇÃO DA UI ---

        // Função central para atualizar toda a UI com o estado global
        function updateAllUI(state) {
            if (!state || !state.accounts) {
                console.warn("Estado global ainda não pronto, UI não atualizada.");
                return;
            }
            
            // --- LÓGICA DE CÁLCULO (O CÉREBRO) ---
            
            // 1. Calcular Contas Pendentes (Regra de Negócio 2)
            const totalPendingBills = (state.pendingBills || [])
                .filter(bill => !bill.paid)
                .reduce((sum, bill) => sum + (bill.value || 0), 0);

            // 2. Calcular Orçamento Disponível Real (Regra de Negócio 2)
            const realBudget = (state.accounts.conta_principal || 0) - totalPendingBills;
            
            // 3. Calcular Pendências (Regra de Negócio 4)
            const totalToReceive = (state.pending.toReceive || [])
                .filter(item => !item.received)
                .reduce((sum, item) => sum + (item.value || 0), 0);
            
            const totalToPay = (state.pending.toPay || [])
                .filter(item => !item.paid)
                .reduce((sum, item) => sum + (item.value || 0), 0);

            // 4. Calcular Fatura Estimada do Cartão (Regra de Negócio 5)
            const currentBill = state.creditCard.currentBill || 0;
            const fixedEntriesTotal = (state.creditCard.nextFixedEntries || [])
                .filter(e => e.name === "Gympass") // Apenas o Gympass, como no seu relatório
                .reduce((s, e) => s + (e.value || 0), 0);
            const totalEstimatedBill = currentBill + fixedEntriesTotal;


            // --- ATUALIZAR PÁGINA: DASHBOARD (Página 1) ---
            
            realBudgetEl.textContent = formatCurrency(realBudget);
            accountBalanceEl.textContent = formatCurrency(state.accounts.conta_principal || 0);
            pendingBillsEl.textContent = `(-) ${formatCurrency(totalPendingBills)}`;
            
            availableOnAccountEl.textContent = formatCurrency(realBudget);
            walletBalanceEl.textContent = formatCurrency(state.accounts.carteira || 0);
            cofreBalanceEl.textContent = formatCurrency(state.accounts.cofre || 0);
            
            creditCardBillEl.textContent = formatCurrency(totalEstimatedBill);
            creditCardLimitEl.textContent = formatCurrency(state.creditCard.availableLimit || 0);
            creditCardReservedEl.textContent = formatCurrency(state.creditCard.reservedLimit || 0);
            
            toReceiveEl.textContent = formatCurrency(totalToReceive);
            toPayEl.textContent = formatCurrency(totalToPay);
            
            // --- ATUALIZAR PÁGINA: COFRE (Página 3) ---
            cofreTotalEl.textContent = formatCurrency(state.accounts.cofre || 0);
            cofreReservedBillsEl.textContent = formatCurrency(state.cofreDetails.reservedForBills || 0);
            cofreReservedVtEl.textContent = formatCurrency(state.cofreDetails.reservedForVT || 0);
            cofreFreeMoneyEl.textContent = formatCurrency(state.cofreDetails.freeMoney || 0);
            
            // --- ATUALIZAR PÁGINA: ENVELOPE VT (Página 4) ---
            vtBudgetNovEl.textContent = formatCurrency(state.vtEnvelope.budgets?.Novembro || 0);
            vtBudgetDecEl.textContent = formatCurrency(state.vtEnvelope.budgets?.Dezembro || 0);
            vtSpentEl.textContent = formatCurrency(state.vtEnvelope.totalSpent || 0);
            vtRemainingEl.textContent = formatCurrency(state.vtEnvelope.totalBalance || 0);

            // --- ATUALIZAR PÁGINA: RELATÓRIOS (Página 5) ---
            if (pages.reports.style.display !== 'none') {
                if (reportTitle.textContent.includes("Rápido")) {
                    renderSimpleReport(state.transactions || []);
                } else if (reportTitle.textContent.includes("Completo")) {
                    renderFullReport(state.transactions || []);
                }
            }
        }
        
        // --- LÓGICA DE NAVEGAÇÃO E EVENTOS ---

        function setupGlobalEventListeners() {
            // Navegação principal
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const page = button.dataset.page;
                    navigateTo(page);
                });
            });

            // Formulário de Lançamento
            transactionType.addEventListener('change', updateFormUI);
            transactionCategory.addEventListener('change', updateSubcategories);
            launchForm.addEventListener('submit', handleFormSubmit);

            // Modais
            cancelVtBtn.addEventListener('click', () => vtModal.classList.add('hidden'));
            alertCloseBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
            aiModalCancel.addEventListener('click', () => aiModal.classList.add('hidden'));

            // Botões de Relatório
            simpleReportBtn.addEventListener('click', () => renderSimpleReport(globalState.transactions || []));
            fullReportBtn.addEventListener('click', () => renderFullReport(globalState.transactions || []));
            
            // Botão de Análise IA
            analyzeExpensesBtn.addEventListener('click', handleAnalyzeExpenses);
        }

        // Controla a navegação entre as "páginas"
        function navigateTo(pageId) {
            // Esconde todas as páginas
            Object.values(pages).forEach(page => page.style.display = 'none');
            // Mostra a página clicada
            pages[pageId].style.display = 'block';

            // Atualiza o estado dos botões da nav
            navButtons.forEach(button => {
                if (button.dataset.page === pageId) {
                    button.classList.add('text-blue-600', 'bg-blue-100');
                    button.classList.remove('text-gray-600');
                } else {
                    button.classList.add('text-gray-600');
                    button.classList.remove('text-blue-600', 'bg-blue-100');
                }
            });
            
            // Ações específicas ao carregar a página
            if (pageId === 'launch') {
                resetForm();
            }
            if (pageId === 'reports') {
                // Carrega o relatório simples por padrão
                renderSimpleReport(globalState.transactions || []);
            }
        }
        
        // --- LÓGICA DO FORMULÁRIO DE LANÇAMENTO (Página 2) ---

        function resetForm() {
            formTitle.textContent = "Lançar Transação";
            launchForm.reset();
            transactionDate.valueAsDate = new Date(); // Data de hoje
            // Reseta o estado do formulário para "Gasto"
            updateFormUI();
        }

        // Atualiza o formulário com base no Tipo de Transação
        function updateFormUI() {
            const type = transactionType.value;
            
            if (type === 'Gasto') {
                paymentOriginContainer.classList.remove('hidden');
                destinationContainer.classList.add('hidden');
                categoryContainer.classList.remove('hidden');
                subcategoryContainer.classList.remove('hidden');
                tagsContainer.classList.remove('hidden');
                isReimbursementContainer.classList.remove('hidden');
                populateCategories('Gasto');
            } else if (type === 'Recebimento') {
                paymentOriginContainer.classList.add('hidden');
                destinationContainer.classList.remove('hidden'); // Onde o dinheiro entra
                categoryContainer.classList.remove('hidden');
                subcategoryContainer.classList.remove('hidden');
                tagsContainer.classList.add('hidden');
                isReimbursementContainer.classList.add('hidden');
                populateCategories('Recebimento');
            } else { // Transferência
                paymentOriginContainer.classList.remove('hidden');
                destinationContainer.classList.remove('hidden');
                categoryContainer.classList.add('hidden');
                subcategoryContainer.classList.add('hidden');
                tagsContainer.classList.add('hidden');
                isReimbursementContainer.classList.add('hidden');
            }
        }

        function populateCategories(type) {
            transactionCategory.innerHTML = '<option value="">Selecione...</option>';
            categories[type].forEach(cat => {
                transactionCategory.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            transactionSubcategory.innerHTML = ''; // Limpa subcategorias
        }
        
        function updateSubcategories() {
            const category = transactionCategory.value;
            transactionSubcategory.innerHTML = '<option value="">Selecione...</option>';
            
            if (subcategories[category]) {
                subcategories[category].forEach(subcat => {
                    transactionSubcategory.innerHTML += `<option value="${subcat}">${subcat}</option>`;
                });
            }
        }

        // Manipulador principal de envio do formulário
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                value: parseFloat(transactionValue.value),
                date: transactionDate.value,
                description: transactionDescription.value,
                type: transactionType.value,
                origin: paymentOrigin.value,
                destination: destinationAccount.value,
                category: transactionCategory.value,
                subcategory: transactionSubcategory.value,
                tags: transactionTags.value,
                isReimbursement: isReimbursement.checked
            };
            
            if (!formData.value || !formData.date || !formData.description) {
                showAlert("Valor, Data e Descrição são obrigatórios.");
                return;
            }

            showLoading("Salvando transação...");

            try {
                // --- LÓGICA DE NEGÓCIO 1: SEPARAÇÃO SALÁRIO vs. VT ---
                if (formData.type === 'Recebimento' && formData.category === 'Salário') {
                    const salaryData = await handleSalaryEntry(formData);
                    // Se o usuário cancelar o modal de VT, interrompemos o salvamento
                    if (!salaryData) {
                        hideLoading();
                        return;
                    }
                    // O handleSalaryEntry já cuidou do batch, podemos só resetar
                    resetForm();
                    navigateTo('dashboard');
                    hideLoading();
                    return; // Importante
                }

                // --- LÓGICA PADRÃO DE BATCH (Gasto, Transferência, Outros Recebimentos) ---
                const batch = writeBatch(db);
                const userDocRef = doc(db, `gestorFinanceiro/${userId}`);
                
                let updatedState = JSON.parse(JSON.stringify(globalState)); // Cópia profunda
                
                // 1. Adicionar transação à subcoleção
                const newTransRef = doc(collection(userDocRef, "transactions"));
                batch.set(newTransRef, {
                    ...formData,
                    createdAt: serverTimestamp()
                });
                
                // 2. Atualizar saldos das contas (Regra de Negócio 3)
                if (formData.type === 'Gasto') {
                    if (formData.origin !== 'cartao_credito') {
                        updatedState.accounts[formData.origin] -= formData.value;
                    }
                } else if (formData.type === 'Recebimento') {
                    updatedState.accounts[formData.destination] += formData.value;
                } else if (formData.type === 'Transferência') {
                    updatedState.accounts[formData.origin] -= formData.value;
                    updatedState.accounts[formData.destination] += formData.value;
                }
                
                // 3. Atualizar documento principal com novos saldos
                batch.update(userDocRef, {
                    "accounts.conta_principal": updatedState.accounts.conta_principal,
                    "accounts.carteira": updatedState.accounts.carteira,
                    "accounts.cofre": updatedState.accounts.cofre,
                    "accounts.cartao_transporte": updatedState.accounts.cartao_transporte
                });

                // 4. Lidar com reembolsos (Regra de Negócio 4)
                if (formData.isReimbursement) {
                    const newPending = {
                        id: `reim-${Date.now()}`,
                        from: "Reembolso", // Origem genérica
                        reason: formData.description,
                        value: formData.value,
                        received: false
                    };
                    updatedState.pending.toReceive.push(newPending);
                    batch.update(userDocRef, {
                        "pending.toReceive": updatedState.pending.toReceive
                    });
                }
                
                // 5. Lidar com gastos no Cartão de Crédito (Regra de Negócio 5)
                if (formData.origin === 'cartao_credito') {
                    updatedState.creditCard.currentBill += formData.value;
                    updatedState.creditCard.availableLimit -= formData.value;
                    batch.update(userDocRef, {
                        "creditCard.currentBill": updatedState.creditCard.currentBill,
                        "creditCard.availableLimit": updatedState.creditCard.availableLimit
                    });
                    
                    // --- LÓGICA DE IA PROATIVA ---
                    // Se o gasto for "alto" (ex: > R$ 50), pergunta sobre a meta
                    if (formData.value > 50) {
                        // Não esperamos essa função, ela roda em segundo plano
                        triggerAIAssistant(formData);
                    }
                }
                
                // 6. Lidar com gastos de VT (Regra de Negócio 1)
                if (formData.subcategory === 'Recarga VT') {
                     updatedState.vtEnvelope.totalSpent += formData.value;
                     updatedState.vtEnvelope.totalBalance -= formData.value;
                     // A origem (de onde o dinheiro saiu) já foi tratada no passo 2
                     // Agora atualiza o envelope VT
                     batch.update(userDocRef, {
                        "vtEnvelope.totalSpent": updatedState.vtEnvelope.totalSpent,
                        "vtEnvelope.totalBalance": updatedState.vtEnvelope.totalBalance
                    });
                }

                // Executa o batch
                await batch.commit();

                // Sucesso
                resetForm();
                navigateTo('dashboard');
                hideLoading();

            } catch (error) {
                console.error("Erro ao salvar transação:", error);
                showError(`Erro ao salvar: ${error.message}`);
                hideLoading();
            }
        }
        
        // Função especial para Lógica de Negócio 1
        function handleSalaryEntry(salaryFormData) {
            return new Promise((resolve) => {
                vtModal.classList.remove('hidden');

                const handleSave = async () => {
                    const vtAmount = parseFloat(vtAmountInput.value) || 0;
                    const netSalary = salaryFormData.value - vtAmount;
                    
                    vtModal.classList.add('hidden');
                    showLoading("Salvando salário e VT...");
                    
                    try {
                        const batch = writeBatch(db);
                        const userDocRef = doc(db, `gestorFinanceiro/${userId}`);
                        
                        let updatedState = JSON.parse(JSON.stringify(globalState));
                        
                        // 1. Adicionar transação de Salário Líquido
                        const salaryTransRef = doc(collection(userDocRef, "transactions"));
                        batch.set(salaryTransRef, {
                            ...salaryFormData,
                            value: netSalary,
                            description: `${salaryFormData.description} (Líquido)`,
                            category: "Salário"
                        });
                        
                        // 2. Adicionar transação de Recebimento de VT (virtual)
                        const vtTransRef = doc(collection(userDocRef, "transactions"));
                        batch.set(vtTransRef, {
                            ...salaryFormData,
                            value: vtAmount,
                            description: "Recebimento de Vale Transporte",
                            category: "Recebimento",
                            subcategory: "VT"
                        });
                        
                        // 3. Atualizar saldo da conta (recebe o valor total)
                        updatedState.accounts[salaryFormData.destination] += salaryFormData.value;
                        
                        // 4. Atualizar Envelope VT
                        const month = new Date(salaryFormData.date).toLocaleString('pt-BR', { month: 'long' });
                        const monthCapitalized = month.charAt(0).toUpperCase() + month.slice(1);
                        
                        if (!updatedState.vtEnvelope.budgets[monthCapitalized]) {
                            updatedState.vtEnvelope.budgets[monthCapitalized] = 0;
                        }
                        updatedState.vtEnvelope.budgets[monthCapitalized] += vtAmount;
                        updatedState.vtEnvelope.totalBalance += vtAmount;
                        
                        // 5. Atualizar o documento principal no Firebase
                        batch.update(userDocRef, {
                            "accounts.conta_principal": updatedState.accounts.conta_principal,
                            "accounts.carteira": updatedState.accounts.carteira,
                            "accounts.cofre": updatedState.accounts.cofre,
                            "accounts.cartao_transporte": updatedState.accounts.cartao_transporte,
                            "vtEnvelope.budgets": updatedState.vtEnvelope.budgets,
                            "vtEnvelope.totalBalance": updatedState.vtEnvelope.totalBalance
                        });

                        await batch.commit();
                        resolve(true); // Sucesso

                    } catch (error) {
                        console.error("Erro ao salvar entrada de salário:", error);
                        showError(`Erro ao salvar salário: ${error.message}`);
                        resolve(false); // Falha
                    }
                };

                const handleCancel = () => {
                    vtModal.classList.add('hidden');
                    resolve(false); // Usuário cancelou
                };

                saveVtBtn.onclick = handleSave; // Use .onclick para sobrescrever listeners antigos
                cancelVtBtn.onclick = handleCancel;
            });
        }

        // --- LÓGICA DOS RELATÓRIOS (Página 5) ---

        function renderSimpleReport(transactions) {
            reportTitle.textContent = "Relatório Rápido (Gastos Variáveis)";
            simpleReportBtn.classList.add('bg-blue-600', 'text-white');
            simpleReportBtn.classList.remove('bg-gray-200', 'text-gray-700');
            fullReportBtn.classList.add('bg-gray-200', 'text-gray-700');
            fullReportBtn.classList.remove('bg-blue-600', 'text-white');
            
            reportTableHead.innerHTML = `
                <tr>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Categoria</th>
                    <th class="p-3 text-right text-sm font-semibold text-gray-600">Total (R$)</th>
                </tr>
            `;
            
            const excludedCategories = ["Contas Fixas", "Dívidas", "Pagamento Fatura"];
            const variableExpenses = transactions.filter(tx => 
                tx.type === 'Gasto' && 
                !excludedCategories.includes(tx.category)
            );
            
            const summary = {};
            let totalVariable = 0;

            variableExpenses.forEach(tx => {
                const cat = tx.category || "Sem Categoria";
                if (!summary[cat]) {
                    summary[cat] = 0;
                }
                summary[cat] += tx.value;
                totalVariable += tx.value;
            });
            
            reportTableBody.innerHTML = '';
            for (const category in summary) {
                reportTableBody.innerHTML += `
                    <tr class="border-b border-gray-200">
                        <td class="p-3">${category}</td>
                        <td class="p-3 text-right">${formatCurrency(summary[category])}</td>
                    </tr>
                `;
            }
            
            // Linha de Total
            reportTableBody.innerHTML += `
                <tr class="bg-gray-100 font-bold">
                    <td class="p-3">Total Variável</td>
                    <td class="p-3 text-right">${formatCurrency(totalVariable)}</td>
                </tr>
            `;
        }
        
        function renderFullReport(transactions) {
            reportTitle.textContent = "Relatório Completo (Alocação Total)";
            fullReportBtn.classList.add('bg-blue-600', 'text-white');
            fullReportBtn.classList.remove('bg-gray-200', 'text-gray-700');
            simpleReportBtn.classList.add('bg-gray-200', 'text-gray-700');
            simpleReportBtn.classList.remove('bg-blue-600', 'text-white');
            
            reportTableHead.innerHTML = `
                <tr>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Categoria</th>
                    <th class="p-3 text-right text-sm font-semibold text-gray-600">Total (R$)</th>
                    <th class="p-3 text-right text-sm font-semibold text-gray-600">% do Total</th>
                </tr>
            `;
            
            const allExpenses = transactions.filter(tx => tx.type === 'Gasto');
            const summary = {};
            let totalExpenses = 0;

            allExpenses.forEach(tx => {
                const cat = tx.category || "Sem Categoria";
                if (!summary[cat]) {
                    summary[cat] = 0;
                }
                summary[cat] += tx.value;
                totalExpenses += tx.value;
            });
            
            reportTableBody.innerHTML = '';
            const sortedCategories = Object.keys(summary).sort((a, b) => summary[b] - summary[a]);

            for (const category of sortedCategories) {
                const total = summary[category];
                const percentage = totalExpenses > 0 ? (total / totalExpenses * 100).toFixed(1) : 0;
                reportTableBody.innerHTML += `
                    <tr class="border-b border-gray-200">
                        <td class="p-3">${category}</td>
                        <td class="p-3 text-right">${formatCurrency(total)}</td>
                        <td class="p-3 text-right">${percentage}%</td>
                    </tr>
                `;
            }
            
            // Linha de Total
            reportTableBody.innerHTML += `
                <tr class="bg-gray-100 font-bold">
                    <td class="p-3">Total de Gastos</td>
                    <td class="p-3 text-right">${formatCurrency(totalExpenses)}</td>
                    <td class="p-3 text-right">100%</td>
                </tr>
            `;
        }
        
        // --- LÓGICA DA IA (GEMINI API) ---
        
        // A API KEY é deixada em branco por padrão no Canvas.
        // O Netlify/ambiente de hospedagem precisa que a API Key 
        // seja fornecida de outra forma (ex: variáveis de ambiente),
        // ou você pode colar sua própria chave aqui se for para uso pessoal.
        // **NÃO FAÇA ISSO SE O REPOSITÓRIO FOR PÚBLICO.**
        const API_KEY = ""; // Mantenha em branco por segurança
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // Função de chamada da API com retry
        async function callGeminiAPI(prompt, isHtml = false) {
            
            // Verificação de segurança: Não chame a API se a chave não estiver presente.
            // (No Netlify/GitHub, você precisará de um backend ou proxy para proteger sua chave)
            if(API_KEY === "") {
                console.warn("API_KEY do Gemini não configurada. Funções de IA estão desabilitadas.");
                // Retorna uma resposta padrão para não quebrar o app
                if (isHtml) return "<p>Função de IA desabilitada. (API Key não configurada)</p>";
                return "Função de IA desabilitada.";
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: isHtml ? "text/html" : "text/plain",
                }
            };

            let response;
            let retries = 3;
            let delay = 1000; // 1 segundo

            while (retries > 0) {
                try {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error("Resposta da API mal formatada");
                        }
                    } else {
                         const errorBody = await response.text();
                         console.error("Erro da API:", response.status, errorBody);
                        throw new Error(`Erro da API: ${response.status}`);
                    }

                } catch (error) {
                    console.warn(`Tentativa de API falhou: ${error.message}. Tentando novamente em ${delay}ms...`);
                    retries--;
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw error; // Desiste após 3 tentativas
                    }
                }
            }
        }
        
        // Lógica de IA Proativa (Regra de Negócio/Filosofia)
        function triggerAIAssistant(transaction) {
            // Roda em segundo plano
            (async () => {
                const prompt = `
                    Persona: Você é o "Meu Gestor Financeiro", um assistente de IA objetivo e focado em metas.
                    Contexto: Meu usuário é um estudante de enfermagem com a META PRIORITÁRIA de "Quitar o Cartão de Crédito".
                    Evento: Ele acabou de registrar um gasto de R$ ${transaction.value.toFixed(2)} no cartão de crédito, descrito como "${transaction.description}".
                    Tarefa: Gere uma única pergunta curta, objetiva e não-julgadora (máximo 2 frases) que o faça refletir se essa compra se alinha com sua meta prioritária.
                    Exemplo de Tom: "Notei este gasto. Como ele se encaixa no seu plano de quitar o cartão este mês?"
                `;
                
                try {
                    const aiMessage = await callGeminiAPI(prompt);
                    
                    // Mostra o modal de IA
                    aiModalMessage.textContent = aiMessage;
                    aiModal.classList.remove('hidden');
                    
                    aiModalConfirm.onclick = () => aiModal.classList.add('hidden');
                    aiModalCancel.onclick = () => aiModal.classList.add('hidden');
                    
                } catch (error) {
                    console.error("Erro ao chamar IA proativa:", error);
                    // Falha silenciosamente, não queremos interromper o usuário
                }
            })();
        }
        
        // Análise de Gastos do Dashboard
        async function handleAnalyzeExpenses() {
            showLoading("Gestor está analisando seus gastos...");
            
            const recentTransactions = globalState.transactions
                .filter(tx => tx.type === 'Gasto')
                .slice(0, 20) // Pega as 20 transações mais recentes
                .map(tx => `- ${tx.date}: R$ ${tx.value.toFixed(2)} em ${tx.category} (${tx.description})`);
            
            const prompt = `
                Persona: Você é o "Meu Gestor Financeiro", um IA proativo e objetivo.
                Contexto: Meu usuário é um estudante de enfermagem. Minhas metas são 1) Quitar Cartão de Crédito, 2) Juntar para um Tablet, 3) Investir.
                Dados: Aqui estão meus últimos 20 gastos:
                ${recentTransactions.join('\n')}
                
                Tarefa: Analise esses gastos e me dê um insight PROATIVO e curto (máximo 3 parágrafos). 
                Identifique padrões de risco (ex: muitos gastos com "Lanche") ou me dê um encorajamento se meus gastos estiverem alinhados com minhas metas.
                Formato: Responda em HTML simples (parágrafos <p> e listas <ul>).
            `;
            
            try {
                const analysisHtml = await callGeminiAPI(prompt, true);
                showAlert(analysisHtml, "Análise do Gestor");
            } catch (error) {
                console.error("Erro na análise de IA:", error);
                showAlert("Desculpe, não consegui analisar seus gastos agora.");
            } finally {
                hideLoading();
            }
        }
        
        // --- FUNÇÕES UTILITÁRIAS ---

        function formatCurrency(value) {
            if (typeof value !== 'number') value = 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }).replace('R$', '').trim();
        }

        function showAlert(message, title = "Aviso") {
            const alertTitleEl = document.getElementById('alert-title');
            alertTitleEl.textContent = title;
            alertMessage.innerHTML = message; // Use innerHTML para o HTML da IA
            // Simplesmente mostra o modal de alerta
            alertModal.classList.remove('hidden');
        }

        function showError(message) {
            // Uma função de alerta específica para erros
            showAlert(`<span class="font-bold text-red-700">Erro:</span> ${message}`, "Erro");
        }
        
        function showLoading(message = "Carregando...") {
            loadingModalMessage.textContent = message;
            loadingModal.classList.remove('hidden');
        }
        
        function hideLoading() {
            loadingModal.classList.add('hidden');
        }

        // Carregar estado offline se o Firebase falhar
        function loadOfflineState() {
            try {
                const storedState = localStorage.getItem('gestorFinanceiroState');
                if (storedState) {
                    globalState = JSON.parse(storedState);
                    showAlert("Não foi possível conectar ao Firebase. Carregando dados locais. As alterações podem não ser salvas.");
                } else {
                    // Se não há dados locais, carrega o seed inicial offline
                    globalState = { ...initialSeedData };
                    showAlert("Não foi possível conectar ao Firebase. Carregando dados de exemplo offline.");
                }
            } catch (e) {
                console.error("Erro ao carregar estado offline:", e);
                showAlert("Erro ao carregar dados locais.");
            }
        }
        
        // Salvar estado offline
        window.addEventListener('beforeunload', () => {
            if (globalState && globalState.accounts) {
                try {
                    localStorage.setItem('gestorFinanceiroState', JSON.stringify(globalState));
                } catch (e) {
                    console.warn("Não foi possível salvar estado offline:", e);
                }
            }
        });
        
    </script>
</html>